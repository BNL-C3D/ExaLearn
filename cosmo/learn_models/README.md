# Active Learning on Predicting Cosmological Parameters

Yihui (Ray) Ren

yren@bnl.gov

## Problem Statement
We want to find a data-efficient way to train a neural network model to predict
the cosmological parameters. The method we are currently investigating belongs
to the type of active learning.

## Data 
The data are generated by performing cosmology
simulations varying the parameter $\omega_m$ from 0.15 to 0.40 and $w_0$ from
-1.2 to -0.8.  We simplify the problem from a parameter regression problem to a
classification problem depend on the value of $\omega_m$, from 0.15 to 0.4 with
step size of 0.05, resulting six classes: [0.15, 0.20, 0.25, 0.30, 0.35, 0.40].
Each data point is a 3D histogram of a 3D-subvolume of the simulated universe.
Overall, we have gathered 3120 data points in total. We randomly splitet it to
training data of 2808 data points and 312 data points for testing.  We further
sub-split the training dataset to training and validation.  The data generation
and setup can be found [here](https://github.com/BNL-C3D/ExaLearn/tree/master/cosmo).
The mapping of class-id to $\omega_m$ is in-order.

## Neural Network Models
We tested the original [CosmoFlow](https://arxiv.org/abs/1808.04728) model
(similar to AlexNet) and a ResNet3D model we composed. The Figure [TODO] shows
both model can achieve very high accuracy when data are sufficient.  But the
ResNet3D model has fewer parameters and faster to train.  We split the training
dataset to training and validation with a fixed random seed.  So the variation
of model accuracy is solely due to the randomness of model weights
intialization and mini-batch shuffling. During training, the best-performing
model according to the validation data set is saved.  During testing, we
measured the performance of the model using the test data set.

* [TODO] report number of parameters, and the training time per epoch. 
    - cosmoflow: 180 sec per epoch (bsz=16)
    - resnet3D : 
* [TODO] report the hyper parameters, and optimizer
* [TODO] insert the result figure

## Accuracy w.r.t. the Amount of Training Data
This investigation answers the question that by randomly sampling a subset of
the training data of a fixed amount, what is the expected model performance?
This will also serve as a baseline for the active learning, and provide an
intuition about how to stage the active learning training. Namely, what amount
of initial seeding data should we use and what amount of the additional data
for each stage.

* [TODO] insert the result figure

## Ensemble Model
The unguaranteed model performance when training data are scarce will cause trouble 
for active learning, because the selection of the subsequent data points are based 
on the current version of the model. To tackle this, we developed a distributed ensemble 
model (consisting of the same type of models but different random process).
Figure [TODO] shows the performance advantage comparing to a single model.

* [TODO] insert the result figure

## Disparity of Performance between different classes




## accuracy improvement w.r.t. amount of training data

## accuracy improvement w.r.t. number of models in ensemble

## accuracy disparity among classes
rank 0 has acc 0.8846153846153846
rank 1 has acc 0.8717948717948718
rank 2 has acc 0.9775641025641025
rank 3 has acc 0.6698717948717948

opt 1 acc =  0.9230769230769231
opt 2 acc =  0.9294871794871795

tot per class [49. 60. 55. 56. 49. 43.]
rank: 0 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 1 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 2 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 3 train tot per_class [ 84.  94.  91.  90. 100. 102.]

|                         | class-0   |    class-1  |    class-2   |     class-3  |    class-4   |    class-5  |
|-------------------------|-----------|-------------|--------------|--------------|--------------|-------------|
|rank_0_has_acc_per_class | 1.0000    |    0.9000   |     0.5091   |     0.9464   |     1.0000   |     1.0000  |
|rank_1_has_acc_per_class | 1.0000    |    0.8833   |     0.8727   |     0.7500   |     0.7551   |     1.0000  |
|rank_2_has_acc_per_class | 1.0000    |    1.0000   |     0.9636   |     0.9107   |     1.0000   |     1.0000  |
|rank_3_has_acc_per_class | 1.0000    |    0.9000   |     0.6364   |     0.4821   |     0.0204   |     1.0000  |
|per_class_opt1           | 1.0000    |    0.9667   |     0.9091   |     0.9464   |     0.7143   |     1.0000  |
|per_class_opt2           | 1.0000    |    0.9000   |     0.9455   |     0.7679   |     1.0000   |     1.0000  |




rank 1 has acc 0.9711538461538461
rank 2 has acc 0.8878205128205128
rank 3 has acc 0.9583333333333334
rank 5 has acc 0.8461538461538461
rank 4 has acc 0.8461538461538461
rank 5 has acc_per_class 1.0000 0.9333 0.3818 0.8214 1.0000 1.0000
rank 4 has acc_per_class 1.0000 1.0000 0.3091 0.8571 0.9592 1.0000
rank 7 has acc 0.9743589743589743
rank 6 has acc 0.8365384615384616
rank 7 has acc_per_class 1.0000 0.9833 0.9455 1.0000 0.9184 1.0000
rank 6 has acc_per_class 1.0000 0.6333 0.7636 0.7857 0.9184 1.0000
opt 1 acc =  0.9519230769230769
opt 2 acc =  0.9807692307692307
tot per class [49. 60. 55. 56. 49. 43.]
per class opt1 =  1.0000 1.0000 0.8182 0.9643 0.9388 1.0000
per class opt2 =  1.0000 0.9833 0.9455 0.9821 0.9796 1.0000
rank 0 has acc 0.6955128205128205
rank: 1 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 5 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 2 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 7 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 4 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 6 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 0 train tot per_class [ 84.  94.  91.  90. 100. 102.]
rank: 3 train tot per_class [ 84.  94.  91.  90. 100. 102.]

rank 0 has acc_per_class 0.9184 0.4500 0.9273 0.5893 0.3673 1.0000
rank 1 has acc_per_class 0.9796 1.0000 0.9091 1.0000 0.9388 1.0000
rank 2 has acc_per_class 1.0000 0.8667 0.5636 0.9643 0.9796 1.0000
rank 3 has acc_per_class 1.0000 0.9167 1.0000 1.0000 0.8367 1.0000
rank 4 has acc_per_class 1.0000 1.0000 0.3091 0.8571 0.9592 1.0000
rank 5 has acc_per_class 1.0000 0.9333 0.3818 0.8214 1.0000 1.0000
rank 6 has acc_per_class 1.0000 0.6333 0.7636 0.7857 0.9184 1.0000
rank 7 has acc_per_class 1.0000 0.9833 0.9455 1.0000 0.9184 1.0000
per class opt1        =  1.0000 1.0000 0.8182 0.9643 0.9388 1.0000
per class opt2        =  1.0000 0.9833 0.9455 0.9821 0.9796 1.0000
